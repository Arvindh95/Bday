<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Girrja's Birthday Adventure</title>
  <style>
    :root{
      --bg:#0f1220;
      --text:#f6f1ff;
      --accent:#ff6bb3;
      --accent2:#7cf2ff;
      --good:#6CFFB8;
      --bad:#ff6b6b;
    }
    *{box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;}
    html, body {height:100%; margin:0; background: var(--bg); color:var(--text); overflow:hidden;}
    #wrap{position:fixed; inset:0; display:flex; flex-direction:column;}
    #topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(21,26,46,0.95), rgba(21,26,46,0.55));
      border-bottom:1px solid rgba(255,255,255,0.07);
    }
    #title{display:flex; flex-direction:column; gap:2px; line-height:1.1;}
    #title .big{font-weight:800; font-size:14px;}
    #title .small{font-size:12px; color:rgba(255,255,255,0.75);}
    #hearts{display:flex; gap:6px; align-items:center;}
    .heart{
      width:20px; height:20px; border-radius:6px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,107,179,0.14);
      font-size:12px;
      opacity:0.35;
      transition: opacity .2s, transform .2s;
    }
    .heart.on{opacity:1; transform: scale(1.1);}
    #btnRow{display:flex; gap:8px; align-items:center;}
    button.smallBtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(124,242,255,0.10);
      color:var(--text);
      font-weight:700;
      font-size:12px;
      cursor:pointer;
    }

    #gameArea{position:relative; flex:1; display:flex;}
    canvas{flex:1; width:100%; height:100%; display:block;}

    #controls{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      display:flex; justify-content:space-between; align-items:flex-end;
      pointer-events:none;
    }
    .dpad{
      pointer-events:auto;
      display:grid;
      grid-template-columns: 52px 52px 52px;
      grid-template-rows: 52px 52px;
      gap:6px;
      opacity:0.95;
      user-select:none;
    }
    .padBtn{
      width:52px; height:52px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(21,26,46,0.85);
      color:rgba(255,255,255,0.9);
      font-weight:900;
      font-size:18px;
      display:grid; place-items:center;
      touch-action: none;
    }
    .padBtn:active{background: rgba(255,107,179,0.3);}
    .padBlank{opacity:0; pointer-events:none;}

    #hintBubble{
      position:absolute;
      left:50%; transform:translateX(-50%);
      bottom:130px;
      max-width:min(400px, calc(100% - 20px));
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.15);
      background: rgba(10,12,22,0.9);
      display:none;
      pointer-events:none;
      text-align:center;
      font-size:13px;
    }

    #overlay{
      position:absolute; inset:0;
      display:none;
      background: rgba(0,0,0,0.7);
      align-items:center; justify-content:center;
      padding:14px;
      z-index: 100;
    }
    #card{
      width:min(420px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, #1a1f35, #12152a);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow:hidden;
    }
    #cardHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex; justify-content:space-between; align-items:center;
    }
    #cardHeader .hTitle{font-weight:900; font-size:16px;}
    #closeX{
      border:none; background:transparent; color:rgba(255,255,255,0.7);
      font-size:28px; font-weight:900; cursor:pointer; padding:4px 12px;
    }
    #cardBody{padding:16px; display:flex; flex-direction:column; gap:12px;}
    #cardSub{font-size:13px; color:rgba(255,255,255,0.7);}
    #question{font-size:15px; font-weight:700;}
    input[type="text"]{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color:var(--text);
      font-size:15px;
      outline:none;
    }
    #submitBtn{
      padding:12px;
      border-radius:14px;
      border:none;
      background: linear-gradient(135deg, #ff6bb3, #ff8ec4);
      color:#fff;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
    }
    #feedback{font-size:13px; min-height:20px; text-align:center;}
    .ok{color:var(--good); font-weight:700;}
    .no{color:var(--bad); font-weight:700;}

    #splash, #final{
      position:absolute; inset:0;
      display:flex;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,0.8);
      z-index: 200;
    }
    #final{display:none;}
    .modalCard{
      width:min(500px, 100%);
      border-radius:24px;
      border:1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, #1a1f35, #0d1020);
      box-shadow: 0 30px 80px rgba(0,0,0,0.6);
      padding:20px;
      text-align:center;
    }
    .modalCard h1{margin:0 0 10px; font-size:22px;}
    .modalCard h2{margin:0 0 10px; font-size:28px;}
    .modalCard p{margin:8px 0; color:rgba(255,255,255,0.8); line-height:1.4; font-size:14px;}
    .modalCard .msg{white-space:pre-wrap; font-size:15px; line-height:1.5;}
    .bigBtn{
      margin-top:16px;
      width:100%;
      padding:14px;
      border-radius:16px;
      border:none;
      background: linear-gradient(135deg, #7cf2ff, #5dd9e6);
      color:#0f1220;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
    }
    .bigBtn.pink{background: linear-gradient(135deg, #ff6bb3, #ff8ec4); color:#fff;}
  </style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <div id="title">
      <div class="big">Girrja's Birthday Adventure üíñ</div>
      <div class="small">Collect 5 hearts ‚Üí Open the treasure room</div>
    </div>
    <div id="btnRow">
      <button class="smallBtn" id="resetBtn">Reset</button>
      <div id="hearts"></div>
    </div>
  </div>

  <div id="gameArea">
    <canvas id="c"></canvas>
    <div id="hintBubble"></div>

    <div id="controls">
      <div class="dpad">
        <div class="padBlank"></div>
        <div class="padBtn" data-dir="up">‚ñ≤</div>
        <div class="padBlank"></div>
        <div class="padBtn" data-dir="left">‚óÄ</div>
        <div class="padBtn" data-dir="down">‚ñº</div>
        <div class="padBtn" data-dir="right">‚ñ∂</div>
      </div>
    </div>

    <div id="overlay">
      <div id="card">
        <div id="cardHeader">
          <div class="hTitle" id="itemTitle">Memory</div>
          <button id="closeX">√ó</button>
        </div>
        <div id="cardBody">
          <div id="cardSub"></div>
          <div id="question"></div>
          <input id="answerInput" type="text" placeholder="Type your answer..." autocomplete="off" />
          <button id="submitBtn">Unlock Heart üíó</button>
          <div id="feedback"></div>
        </div>
      </div>
    </div>

    <div id="splash">
      <div class="modalCard">
        <h1>Hi Girrja üíï</h1>
        <p>This is a tiny adventure made just for you!</p>
        <p>üó∫Ô∏è Explore the rooms and find <b>5 glowing hearts</b><br>
        üí¨ Answer the memory question to collect each heart<br>
        üîê Collect all 5 to unlock the <b>treasure room</b><br>
        üéÅ A special surprise waits inside!</p>
        <p style="margin-top:12px; font-size:12px; color:rgba(255,255,255,0.6);">
          Use arrow buttons to move. Walk into hearts to interact.
        </p>
        <button class="bigBtn" id="startBtn">Start Adventure ‚ú®</button>
      </div>
    </div>

    <div id="final">
      <div class="modalCard">
        <h2>üéÇ Happy Birthday, Girrja! üéÇ</h2>
        <p class="msg" id="finalMsg"></p>
        <button class="bigBtn pink" id="replayBtn">Play Again üîÅ</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const FINAL_MESSAGE = `You found the treasure! üíñ

Thank you for being my favorite person in the whole world.
Every memory with you is precious to me.

I love you more than words can say.
Here's to another year of adventures together!

‚Äî Your baby ü•πüíû`;

  const STORAGE_KEY = "girrja_bday_v3";

  // Helpers
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const now = () => performance.now();
  const normalize = s => (s || "").toLowerCase().trim().replace(/[^a-z0-9]+/g, " ").trim();
  const rectsOverlap = (a, b) => a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;

  // Canvas
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  function resize() {
    const dpr = Math.min(3, window.devicePixelRatio || 1);
    canvas.width = Math.floor(canvas.clientWidth * dpr);
    canvas.height = Math.floor(canvas.clientHeight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // UI
  const heartsEl = document.getElementById("hearts");
  const hintBubble = document.getElementById("hintBubble");
  const overlay = document.getElementById("overlay");
  const itemTitle = document.getElementById("itemTitle");
  const cardSub = document.getElementById("cardSub");
  const questionEl = document.getElementById("question");
  const answerInput = document.getElementById("answerInput");
  const submitBtn = document.getElementById("submitBtn");
  const feedback = document.getElementById("feedback");
  const closeX = document.getElementById("closeX");
  const splash = document.getElementById("splash");
  const startBtn = document.getElementById("startBtn");
  const final = document.getElementById("final");
  const finalMsg = document.getElementById("finalMsg");
  const replayBtn = document.getElementById("replayBtn");
  const resetBtn = document.getElementById("resetBtn");

  finalMsg.textContent = FINAL_MESSAGE;

  // ========== MAP DESIGN ==========
  // Simple layout:
  //
  //    [Room 1]   [Room 2]
  //        \       /
  //         [Hall]----[Room 3]
  //        /      \
  //    [Room 4]   [Room 5]
  //               |
  //          [Treasure Room] (locked until 5 hearts)
  //
  
  const world = { w: 900, h: 750 };
  const W = 16; // wall thickness
  const walls = [];
  const addWall = (x, y, w, h) => walls.push({ x, y, w, h });

  // Outer walls
  addWall(0, 0, world.w, W);
  addWall(0, world.h - W, world.w, W);
  addWall(0, 0, W, world.h);
  addWall(world.w - W, 0, W, world.h);

  // Central hallway (horizontal, y: 300-400)
  // Left section walls
  addWall(W, 300, 150, W);
  addWall(W, 400, 150, W);
  
  // Right section walls  
  addWall(650, 300, 234, W);
  addWall(650, 400, 234, W);

  // Room 1 (top-left) - opening at bottom-right
  addWall(W, W, 200, W);
  addWall(200, W, W, 200);
  addWall(W, 200, 120, W);
  // gap from 120 to 200 for door

  // Room 2 (top-right) - opening at bottom-left
  addWall(350, W, 200, W);
  addWall(350, W, W, 200);
  addWall(430, 200, 120, W);
  // gap from 350 to 430 for door

  // Room 3 (right side) - opening on left
  addWall(650, W, 234, W);
  addWall(650, W, W, 220);
  addWall(650, 280, W, 20);
  // gap from 220 to 280

  // Room 4 (bottom-left) - opening at top-right
  addWall(W, 500, 200, W);
  addWall(200, 500, W, 234);
  addWall(W, 500, W, 234);
  addWall(120, 400, 80, W);
  // gap from 120 to 200 (x) at y:400

  // Room 5 (bottom-center) - opening at top
  addWall(300, 500, W, 234);
  addWall(300, 500, 150, W);
  addWall(500, 500, W, 234);
  addWall(450, 500, 50, W);
  addWall(350, 400, 50, W);
  addWall(450, 400, 50, W);
  // gap from 400-450 at y:400

  // Treasure Room (bottom-right) - LOCKED DOOR
  addWall(600, 500, W, 234);
  addWall(600, 500, 284, W);
  // Door position: x:600, y:400-500 (covered by gate)

  // Player
  const player = { x: 400, y: 340, w: 24, h: 32, speed: 150, dir: 1, walking: false };
  const cam = { x: 0, y: 0 };

  // The locked door (gate)
  const gate = { x: 600, y: 400, w: W, h: 100, need: 5 };

  // Items (5 hearts in 5 rooms)
  const items = [
    {
      id: "movie", x: 110, y: 110,
      name: "Movie Ticket üéüÔ∏è",
      subtitle: "Our first movie together...",
      question: "What was the first movie we watched together?",
      answer: "Thiruchitrambalam",
      onWin: "Aww ü•πüíó That memory is safe with you!"
    },
    {
      id: "food", x: 450, y: 110,
      name: "Food Receipt üçó",
      subtitle: "A delicious memory...",
      question: "What's our favourite food shop?",
      answer: "Southern park chicken rice",
      onWin: "Yum üòãüíñ Now I'm craving it!"
    },
    {
      id: "clone", x: 780, y: 150,
      name: "Clone Detector üß™",
      subtitle: "Only the real Girrja knows...",
      question: "If you were a clone, what phrase would I use to find out?",
      answer: "So clever my baby.",
      onWin: "Correct üòåüíû You're the real one!"
    },
    {
      id: "song", x: 110, y: 620,
      name: "Secret Song üé∂",
      subtitle: "A melody with our inside joke...",
      question: "Which song has our inside joke?",
      answer: "Un Vizhigal",
      onWin: "Eee ü•∞üíó Our song!"
    },
    {
      id: "story", x: 400, y: 620,
      name: "Storybook üìñ",
      subtitle: "A story that makes us smile...",
      question: "What's the best story you have heard?",
      answer: "Cool story",
      onWin: "Hehe üòÑüíò That's the one!"
    }
  ];
  items.forEach(it => it.r = 20);

  // Treasure position (in locked room)
  const treasure = { x: 750, y: 620 };

  // State
  let state = { started: false, collected: {}, finished: false };

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const obj = JSON.parse(raw);
        state.started = !!obj.started;
        state.collected = obj.collected || {};
        state.finished = !!obj.finished;
      }
    } catch (e) {}
  }

  function save() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
  }

  function resetAll() {
    state = { started: false, collected: {}, finished: false };
    player.x = 400; player.y = 340;
    save();
    updateHeartsUI();
    final.style.display = "none";
    splash.style.display = "flex";
  }

  function collectedCount() { return Object.keys(state.collected).length; }

  function updateHeartsUI() {
    heartsEl.innerHTML = "";
    const got = collectedCount();
    for (let i = 0; i < 5; i++) {
      const d = document.createElement("div");
      d.className = "heart" + (i < got ? " on" : "");
      d.textContent = "‚ù§";
      heartsEl.appendChild(d);
    }
  }

  // Input
  const input = { up: false, down: false, left: false, right: false };

  document.addEventListener("keydown", e => {
    if (e.key === "ArrowUp" || e.key.toLowerCase() === "w") input.up = true;
    if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") input.down = true;
    if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") input.left = true;
    if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") input.right = true;
  });
  document.addEventListener("keyup", e => {
    if (e.key === "ArrowUp" || e.key.toLowerCase() === "w") input.up = false;
    if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") input.down = false;
    if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") input.left = false;
    if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") input.right = false;
  });

  document.querySelectorAll(".padBtn").forEach(btn => {
    const dir = btn.dataset.dir;
    const start = () => { input[dir] = true; };
    const end = () => { input[dir] = false; };
    btn.addEventListener("touchstart", e => { e.preventDefault(); start(); }, { passive: false });
    btn.addEventListener("touchend", e => { e.preventDefault(); end(); }, { passive: false });
    btn.addEventListener("touchcancel", end);
    btn.addEventListener("mousedown", start);
    btn.addEventListener("mouseup", end);
    btn.addEventListener("mouseleave", end);
  });

  // Collision
  function getWalls() {
    const all = [...walls];
    if (collectedCount() < gate.need) all.push(gate);
    return all;
  }

  function canMove(nx, ny) {
    const r = { x: nx, y: ny, w: player.w, h: player.h };
    for (const wall of getWalls()) {
      if (rectsOverlap(r, wall)) return false;
    }
    return nx >= 0 && ny >= 0 && nx + player.w <= world.w && ny + player.h <= world.h;
  }

  // Item interaction
  let currentItem = null;
  let overlayCooldown = 0;

  function getNearbyItem() {
    const px = player.x + player.w / 2, py = player.y + player.h / 2;
    for (const it of items) {
      if (state.collected[it.id]) continue;
      const d = Math.hypot(px - it.x, py - it.y);
      if (d < 40) return it;
    }
    return null;
  }

  function openOverlay(item) {
    currentItem = item;
    itemTitle.textContent = item.name;
    cardSub.textContent = item.subtitle;
    questionEl.textContent = item.question;
    answerInput.value = "";
    feedback.textContent = "";
    feedback.className = "";
    overlay.style.display = "flex";
    setTimeout(() => answerInput.focus(), 50);
  }

  function closeOverlay() {
    overlay.style.display = "none";
    currentItem = null;
    overlayCooldown = now() + 500; // 500ms cooldown before reopening
  }

  function checkAnswer() {
    if (!currentItem) return;
    if (normalize(answerInput.value) === normalize(currentItem.answer)) {
      feedback.textContent = currentItem.onWin;
      feedback.className = "ok";
      state.collected[currentItem.id] = true;
      save();
      updateHeartsUI();
      setTimeout(closeOverlay, 1200);
    } else {
      feedback.textContent = "Not quite right, try again! üí≠";
      feedback.className = "no";
    }
  }

  // Check if near treasure
  function checkTreasure() {
    if (state.finished) return;
    if (collectedCount() < 5) return;
    const px = player.x + player.w / 2, py = player.y + player.h / 2;
    if (Math.hypot(px - treasure.x, py - treasure.y) < 50) {
      state.finished = true;
      save();
      final.style.display = "flex";
    }
  }

  function updateCamera() {
    const vw = canvas.clientWidth, vh = canvas.clientHeight;
    cam.x = clamp(player.x + player.w / 2 - vw / 2, 0, Math.max(0, world.w - vw));
    cam.y = clamp(player.y + player.h / 2 - vh / 2, 0, Math.max(0, world.h - vh));
  }

  // Draw pixel girl
  function drawPlayer(x, y) {
    ctx.save();
    const px = Math.floor(x), py = Math.floor(y);
    const bob = player.walking ? Math.sin(now() / 80) * 2 : 0;
    
    if (player.dir === -1) {
      ctx.translate(px + player.w, py);
      ctx.scale(-1, 1);
    } else {
      ctx.translate(px, py);
    }

    // Hair back
    ctx.fillStyle = "#2d2d3a";
    ctx.fillRect(2, 2 + bob, 20, 12);
    ctx.fillRect(0, 6 + bob, 3, 18);
    ctx.fillRect(21, 6 + bob, 3, 18);

    // Face
    ctx.fillStyle = "#ffe4d4";
    ctx.fillRect(5, 6 + bob, 14, 12);

    // Hair bangs
    ctx.fillStyle = "#2d2d3a";
    ctx.fillRect(3, 3 + bob, 18, 5);
    ctx.fillRect(3, 6 + bob, 4, 3);
    ctx.fillRect(17, 6 + bob, 4, 3);

    // Hair clip (green)
    ctx.fillStyle = "#5cb85c";
    ctx.fillRect(16, 3 + bob, 5, 4);

    // Eyes
    ctx.fillStyle = "#4a3728";
    ctx.fillRect(7, 10 + bob, 3, 3);
    ctx.fillRect(14, 10 + bob, 3, 3);
    ctx.fillStyle = "#fff";
    ctx.fillRect(7, 10 + bob, 1, 1);
    ctx.fillRect(14, 10 + bob, 1, 1);

    // Blush
    ctx.fillStyle = "#ffb0b0";
    ctx.fillRect(5, 13 + bob, 2, 2);
    ctx.fillRect(17, 13 + bob, 2, 2);

    // Mouth
    ctx.fillStyle = "#e08080";
    ctx.fillRect(10, 15 + bob, 4, 1);

    // Body/dress
    ctx.fillStyle = "#b8f0d8";
    ctx.fillRect(5, 18 + bob, 14, 10);
    ctx.fillStyle = "#90e0c0";
    ctx.fillRect(5, 18 + bob, 14, 2);

    // Arms
    ctx.fillStyle = "#ffe4d4";
    ctx.fillRect(2, 20 + bob, 3, 5);
    ctx.fillRect(19, 20 + bob, 3, 5);

    // Legs
    ctx.fillRect(7, 28 + bob, 3, 3);
    ctx.fillRect(14, 28 + bob, 3, 3);

    // Shoes
    ctx.fillStyle = "#2d2d3a";
    ctx.fillRect(6, 30 + bob, 5, 2);
    ctx.fillRect(13, 30 + bob, 5, 2);

    ctx.restore();
  }

  // Draw
  function draw() {
    const vw = canvas.clientWidth, vh = canvas.clientHeight;
    ctx.clearRect(0, 0, vw, vh);
    ctx.save();
    ctx.translate(-cam.x, -cam.y);

    // Floor
    ctx.fillStyle = "#1a1e30";
    ctx.fillRect(0, 0, world.w, world.h);

    // Floor tiles
    ctx.fillStyle = "#1e2338";
    for (let x = 0; x < world.w; x += 50) {
      for (let y = 0; y < world.h; y += 50) {
        if ((x + y) % 100 === 0) ctx.fillRect(x, y, 50, 50);
      }
    }

    // Room labels
    ctx.fillStyle = "rgba(255,255,255,0.1)";
    ctx.font = "bold 14px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("Room 1", 110, 60);
    ctx.fillText("Room 2", 450, 60);
    ctx.fillText("Room 3", 780, 60);
    ctx.fillText("Room 4", 110, 560);
    ctx.fillText("Room 5", 400, 560);
    ctx.fillText("üîê Treasure", 750, 560);

    // Walls
    ctx.fillStyle = "#3a3f5c";
    for (const w of walls) {
      ctx.fillRect(w.x, w.y, w.w, w.h);
    }

    // Gate (locked door)
    const got = collectedCount();
    if (got < gate.need) {
      const pulse = Math.sin(now() / 400) * 0.2 + 0.8;
      ctx.fillStyle = `rgba(255, 107, 179, ${pulse})`;
      ctx.fillRect(gate.x, gate.y, gate.w, gate.h);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 12px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("üîí", gate.x + gate.w / 2, gate.y + gate.h / 2 - 8);
      ctx.fillText(`${gate.need}‚ù§`, gate.x + gate.w / 2, gate.y + gate.h / 2 + 10);
    } else {
      // Open door glow
      ctx.fillStyle = "rgba(108, 255, 184, 0.3)";
      ctx.fillRect(gate.x, gate.y, gate.w, gate.h);
    }

    // Items (hearts)
    for (const it of items) {
      if (state.collected[it.id]) continue;
      const pulse = Math.sin(now() / 250 + items.indexOf(it)) * 0.3 + 0.7;
      
      // Glow
      ctx.beginPath();
      ctx.arc(it.x, it.y, 30 + pulse * 8, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 107, 179, ${0.2 * pulse})`;
      ctx.fill();

      // Circle
      ctx.beginPath();
      ctx.arc(it.x, it.y, it.r, 0, Math.PI * 2);
      ctx.fillStyle = "#ff6bb3";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.5)";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Heart icon
      ctx.font = "14px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("üíó", it.x, it.y);
    }

    // Treasure (if door is open)
    if (got >= gate.need && !state.finished) {
      const pulse = Math.sin(now() / 200) * 0.3 + 0.7;
      ctx.beginPath();
      ctx.arc(treasure.x, treasure.y, 35 + pulse * 10, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 215, 0, ${0.3 * pulse})`;
      ctx.fill();

      ctx.font = "30px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("üéÅ", treasure.x, treasure.y);
    }

    // Player
    drawPlayer(player.x, player.y);

    ctx.restore();
  }

  // Game loop
  let lastTime = now();

  function loop() {
    const t = now();
    const dt = Math.min((t - lastTime) / 1000, 0.1);
    lastTime = t;

    if (state.started && !state.finished && overlay.style.display !== "flex") {
      let dx = 0, dy = 0;
      if (input.up) dy = -1;
      if (input.down) dy = 1;
      if (input.left) { dx = -1; player.dir = -1; }
      if (input.right) { dx = 1; player.dir = 1; }

      player.walking = dx !== 0 || dy !== 0;
      if (dx && dy) { dx *= 0.707; dy *= 0.707; }

      const mx = dx * player.speed * dt;
      const my = dy * player.speed * dt;
      if (canMove(player.x + mx, player.y)) player.x += mx;
      if (canMove(player.x, player.y + my)) player.y += my;

      // Check item
      const near = getNearbyItem();
      if (near && now() > overlayCooldown) {
        const px = player.x + player.w / 2, py = player.y + player.h / 2;
        if (Math.hypot(px - near.x, py - near.y) < 25) {
          openOverlay(near);
        }
      }

      checkTreasure();

      // Hint
      const gateNear = collectedCount() < gate.need && 
        Math.hypot(player.x + player.w/2 - (gate.x + gate.w/2), player.y + player.h/2 - (gate.y + gate.h/2)) < 80;
      
      if (gateNear) {
        hintBubble.textContent = `üîí Locked! Need ${gate.need} hearts (you have ${collectedCount()})`;
        hintBubble.style.display = "block";
      } else if (near) {
        hintBubble.textContent = `Walk into ${near.name}`;
        hintBubble.style.display = "block";
      } else if (collectedCount() >= 5 && !state.finished) {
        hintBubble.textContent = "‚ú® Go to the treasure room! ‚ú®";
        hintBubble.style.display = "block";
      } else {
        hintBubble.style.display = "none";
      }
    }

    resize();
    updateCamera();
    draw();
    requestAnimationFrame(loop);
  }

  // Events
  startBtn.addEventListener("click", () => {
    state.started = true;
    save();
    splash.style.display = "none";
  });
  startBtn.addEventListener("touchend", e => {
    e.preventDefault();
    state.started = true;
    save();
    splash.style.display = "none";
  }, { passive: false });

  resetBtn.addEventListener("click", resetAll);
  replayBtn.addEventListener("click", resetAll);
  closeX.addEventListener("click", closeOverlay);
  submitBtn.addEventListener("click", checkAnswer);
  answerInput.addEventListener("keydown", e => { if (e.key === "Enter") checkAnswer(); });
  overlay.addEventListener("click", e => { if (e.target === overlay) closeOverlay(); });

  // Init
  load();
  updateHeartsUI();
  if (state.finished) {
    splash.style.display = "none";
    final.style.display = "flex";
  } else if (state.started) {
    splash.style.display = "none";
  }

  window.addEventListener("resize", resize);
  resize();
  loop();
})();
</script>
</body>
</html>
